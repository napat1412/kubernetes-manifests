#!/bin/bash
# Wrapper for launching kubelet via docker. (modified from kubelet-wrapper)
#
# Make sure to set KUBELET_IMAGE_TAG to an image tag published here:
# https://quay.io/repository/coreos/hyperkube?tab=tags Alternatively,
# override KUBELET_IMAGE to a custom image.

set -e

function require_ev_all() {
        for rev in $@ ; do
                if [[ -z "${!rev}" ]]; then
                        echo "${rev}" is not set
                        exit 1
                fi
        done
}

function require_ev_one() {
        for rev in $@ ; do
                if [[ ! -z "${!rev}" ]]; then
                        return
                fi
        done
        echo One of $@ must be set
        exit 1
}

if [[ -n "${KUBELET_VERSION}" ]]; then
        echo KUBELET_VERSION environment variable is deprecated, please use KUBELET_IMAGE_TAG ins
tead
fi


if [[ -n "${KUBELET_ACI}" ]]; then
        echo KUBELET_ACI environment variable is deprecated, please use the KUBELET_IMAGE_URL instead
fi

if [[ -n "${RKT_OPTS}" ]]; then
        echo RKT_OPTS environment variable is deprecated, please use the RKT_RUN_ARGS instead
fi

KUBELET_IMAGE_TAG="${KUBELET_IMAGE_TAG:-${KUBELET_VERSION}}"
require_ev_one KUBELET_IMAGE KUBELET_IMAGE_TAG

KUBELET_IMAGE_URL="${KUBELET_IMAGE_URL:-${KUBELET_ACI:-quay.io/coreos/hyperkube}}"
KUBELET_IMAGE="${KUBELET_IMAGE:-${KUBELET_IMAGE_URL}:${KUBELET_IMAGE_TAG}}"

DOCKER_RUN_ARGS="${DOCKER_RUN_ARGS} ${DOCKER_OPTS}"

mkdir --parents /etc/kubernetes
mkdir --parents /var/lib/docker
mkdir --parents /var/lib/kubelet
mkdir --parents /run/kubelet

DOCKER="${DOCKER:-/usr/bin/docker}"

set -x
exec ${DOCKER} ${DOCKER_GLOBAL_ARGS} \
  run --rm ${DOCKER_RUN_ARGS} \
  --privileged=true \
  --net=host --pid=host \
  --volume=/:/rootfs:ro \
  --volume=/etc/kubernetes:/etc/kubernetes:rw \
  --volume=/etc/ssl/certs:/etc/ssl/certs:ro \
  --volume=/usr/share/ca-certificates:/usr/share/ca-certificates:ro \
  --volume=/var/lib/docker:/var/lib/docker:rw \
  --volume=/var/lib/kubelet:/var/lib/kubelet:rw \
  --volume=/usr/lib/os-release:/etc/os-release:ro \
  --volume=/run:/run:rw \
  ${KUBELET_IMAGE} \
    /kubelet $@
